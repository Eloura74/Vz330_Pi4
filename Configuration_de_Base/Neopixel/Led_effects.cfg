[led_effect barre_temp_ext]
leds:
    neopixel:barre_leds
autostart:                          true
frame_rate:                         24
heater:                             extruder
layers:
    # temperature {vitesse} {temp_mini} {temp_maxi} {mode_fusion} {palette}
    temperature 20 80 add (0,0,1),(1,0,0),(1,1,1)

[gcode_macro PRECHAUFFAGE_PLA]
gcode:
    # On active le mode "glow"
    NEOPIXEL_DISPLAY LED=barre_leds TYPE=extruder_temp MODE=glow
    M140 S60
    M104 S195

[led_effect temp_atteinte]
leds:
    neopixel:barre_leds
autostart:                          false
frame_rate:                         24
layers:
    # blink {fréquence} {ratio} {mode} {couleur}
    # Clignotement 1Hz (1 fois par sec), ratio 50%, Vert pur
    blink 1.0 0.5 top (0.0, 1.0, 0.0)

[gcode_macro PRECHAUFFAGE_PLAV2]
description: Préchauffe PLA avec notification visuelle de fin
gcode:
    # 1. Variables de consigne
    {% set target_extruder = 195 %}
    {% set target_bed = 60 %}

    # 2. Nettoyage des effets précédents et lancement du mode Glow
    STOP_LED_EFFECTS
    SET_LED_TEMPLATE LED=barre_leds TEMPLATE= # Nettoie les templates résiduels
    NEOPIXEL_DISPLAY LED=barre_leds TYPE=extruder_temp MODE=glow
    
    # 3. Lancement des chauffes
    M140 S{target_bed}
    M104 S{target_extruder}
    M117 Chauffe en cours...

    # 4. Attente active de la température de la buse
    # SENSOR doit correspondre au nom de votre section [extruder]
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={target_extruder - 1} MAXIMUM={target_extruder + 5}

    # 5. Déclenchement du clignotement final
    SET_LED_TEMPLATE LED=barre_leds TEMPLATE= # Désactive le mode Glow
    SET_LED_EFFECT EFFECT=temp_atteinte REPLACE=1
    M117 Température PLA atteinte !
    {action_respond_info("Préchauffage terminé : 195°C atteint.")}
# # ==========================================================================================
# # CONFIGURATION LED - VERSION STABLE (SANS {{ }}, SANS PARAMS TEMPLATE CUSTOM)
# # ==========================================================================================

# # 1) EFFETS (PLUGIN led_effect)
# # ------------------------------------------------------------------------------------------

# [led_effect barre_ready]
# leds: neopixel:barre_leds
# layers: breathing 5 1 top (0,0,0.3)
# frame_rate: 10

# [led_effect barre_homing]
# leds: neopixel:barre_leds
# layers: comet 1 1 top (0,1,0)
# frame_rate: 10

# [led_effect barre_leveling]
# leds: neopixel:barre_leds
# layers: comet 1 1 top (0.5,0,0.5)
# frame_rate: 10

# [led_effect barre_done]
# leds: neopixel:barre_leds
# layers: static 1 1 top (0,1,0)
# frame_rate: 10


# # 2) VARIABLES
# # ------------------------------------------------------------------------------------------

# [gcode_macro _ZTILT_VARS]
# variable_last_left_ok: 2
# variable_last_right_ok: 2
# gcode:
#     M118 Variables LED OK.


# # 3) READY
# # ------------------------------------------------------------------------------------------

# [gcode_macro status_readyV2]
# gcode:
#     UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0
#     STOP_LED_EFFECTS
#     SET_LED_TEMPLATE LED=barre_leds TEMPLATE=
#     SET_LED_EFFECT EFFECT=barre_ready


# # 4) HEATING LIVE (PROGRESSION BLEU->ROUGE) - COMPATIBLE PARTOUT
# # ------------------------------------------------------------------------------------------
# # IMPORTANT: mets le bon nombre de LED ici (chain_count réel)
# [gcode_macro STATUS_HEATING_START]
# description: Démarre l’affichage chauffe (barre bleu->rouge)
# variable_led_count: 8
# gcode:
#     STOP_LED_EFFECTS
#     SET_LED_TEMPLATE LED=barre_leds TEMPLATE=
#     UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0.10

# [gcode_macro STATUS_HEATING_STOP]
# description: Stop affichage chauffe + éteint
# gcode:
#     UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0
#     SET_LED_TEMPLATE LED=barre_leds TEMPLATE=
#     SET_LED LED=barre_leds RED=0 GREEN=0 BLUE=0 TRANSMIT=1

# [delayed_gcode _LED_HEATING_REFRESH]
# gcode:
#     {% set total = printer["gcode_macro STATUS_HEATING_START"].led_count|int %}
#     {% set temp = printer.extruder.temperature|float %}
#     {% set target = printer.extruder.target|default(0)|float %}

#     {% if target <= 0 %}
#         {% for i in range(total) %}
#             SET_LED LED=barre_leds INDEX={i+1} RED=0 GREEN=0 BLUE=0.02 TRANSMIT=0
#         {% endfor %}
#         SET_LED LED=barre_leds TRANSMIT=1
#         UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0.25
#     {% else %}
#         {% set ratio = (temp / target)|float %}
#         {% if ratio > 1.0 %}{% set ratio = 1.0 %}{% endif %}
#         {% if ratio < 0.0 %}{% set ratio = 0.0 %}{% endif %}

#         {% set filled = (ratio * total)|int %}
#         {% if ratio > 0 and filled < 1 %}{% set filled = 1 %}{% endif %}
#         {% if filled > total %}{% set filled = total %}{% endif %}

#         {% set reached = temp >= (target - 2.0) %}
#         {% set t = printer.toolhead.time|default(0)|float %}
#         {% set blink = ((t * 4)|int) % 2 %}

#         {% set r = ratio %}
#         {% if r < 0.15 %}{% set r = 0.15 %}{% endif %}
#         {% set b = (1.0 - ratio) %}
#         {% if b < 0.15 %}{% set b = 0.15 %}{% endif %}

#         {% for i in range(total) %}
#             {% if i < filled %}
#                 {% if reached and blink == 0 %}
#                     SET_LED LED=barre_leds INDEX={i+1} RED=0 GREEN=0 BLUE=0 TRANSMIT=0
#                 {% else %}
#                     SET_LED LED=barre_leds INDEX={i+1} RED={r} GREEN=0 BLUE={b} TRANSMIT=0
#                 {% endif %}
#             {% else %}
#                 SET_LED LED=barre_leds INDEX={i+1} RED=0 GREEN=0 BLUE=0.02 TRANSMIT=0
#             {% endif %}
#         {% endfor %}
#         SET_LED LED=barre_leds TRANSMIT=1

#         UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0.10
#     {% endif %}


# # 5) ZTILT LIVE - VERSION MACRO (LED 1 / LED 8) COMPATIBLE
# # ------------------------------------------------------------------------------------------
# # IMPORTANT: mets le bon nombre de LED ici aussi.
# [gcode_macro status_ztilt_liveV2]
# description: Feedback ZTilt simple (LED1/LED8)
# variable_led_count: 8
# gcode:
#     {% set total = printer["gcode_macro status_ztilt_liveV2"].led_count|int %}
#     {% set x = printer.toolhead.position.x|float %}
#     {% set vars = printer["gcode_macro _ZTILT_VARS"] %}
#     {% set live_dist = (printer.bdsensor.distance|default(99)|float) if ('bdsensor' in printer) else 99.0 %}

#     STOP_LED_EFFECTS
#     SET_LED_TEMPLATE LED=barre_leds TEMPLATE=

#     {% for i in range(total) %}
#         SET_LED LED=barre_leds INDEX={i+1} RED=0 GREEN=0 BLUE=0.02 TRANSMIT=0
#     {% endfor %}

#     {% if x < 100 %}
#         {% if live_dist < 0.1 or vars.last_left_ok == 1 %}
#             SET_LED LED=barre_leds INDEX=8 RED=0 GREEN=1 BLUE=0 TRANSMIT=0
#         {% elif vars.last_left_ok == 0 %}
#             SET_LED LED=barre_leds INDEX=8 RED=1 GREEN=0 BLUE=0 TRANSMIT=0
#         {% else %}
#             SET_LED LED=barre_leds INDEX=8 RED=0 GREEN=0 BLUE=1 TRANSMIT=0
#         {% endif %}
#     {% else %}
#         SET_LED LED=barre_leds INDEX=8 RED=0 GREEN=0 BLUE=0 TRANSMIT=0
#     {% endif %}

#     {% if x > 200 %}
#         {% if live_dist < 0.1 or vars.last_right_ok == 1 %}
#             SET_LED LED=barre_leds INDEX=1 RED=0 GREEN=1 BLUE=0 TRANSMIT=0
#         {% elif vars.last_right_ok == 0 %}
#             SET_LED LED=barre_leds INDEX=1 RED=1 GREEN=0 BLUE=0 TRANSMIT=0
#         {% else %}
#             SET_LED LED=barre_leds INDEX=1 RED=0 GREEN=0 BLUE=1 TRANSMIT=0
#         {% endif %}
#     {% else %}
#         SET_LED LED=barre_leds INDEX=1 RED=0 GREEN=0 BLUE=0 TRANSMIT=0
#     {% endif %}

#     SET_LED LED=barre_leds TRANSMIT=1


# # 6) STOP / OFF
# # ------------------------------------------------------------------------------------------

# [gcode_macro TEST_LED_STOP]
# gcode:
#     UPDATE_DELAYED_GCODE ID=_LED_HEATING_REFRESH DURATION=0
#     STOP_LED_EFFECTS
#     SET_LED_TEMPLATE LED=barre_leds TEMPLATE=
#     SET_LED LED=barre_leds RED=0 GREEN=0 BLUE=0 TRANSMIT=1


# # 7) INIT
# # ------------------------------------------------------------------------------------------

# [delayed_gcode INIT_LEDS_SECURE]
# initial_duration: 15.0
# gcode:
#     status_readyV2
